<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPCA Smart Weather System</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #141e30, #243b55);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  color: white;
}

.card {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(20px);
  width: 650px;
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.4);
}

h2 { text-align:center; }

.status {
  text-align:center;
  padding:8px;
  border-radius:8px;
  margin-bottom:10px;
  font-weight:bold;
}

.row {
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,0.2);
}

canvas {
  margin-top:15px;
  background:white;
  border-radius:10px;
}

.footer {
  text-align:center;
  margin-top:10px;
  font-size:12px;
  opacity:0.8;
}
</style>
</head>

<body>

<div class="card">
  <h2>ğŸŒ¦ GPCA Smart Weather System</h2>

  <div id="deviceStatus" class="status">Checking...</div>
  <div id="alertBox" class="status" style="display:none;"></div>

  <div class="row"><span>ğŸŒ¡ Temperature</span><span id="temp"></span></div>
  <div class="row"><span>ğŸ“Š Trend</span><span id="trend"></span></div>
  <div class="row"><span>ğŸ’§ Humidity</span><span id="hum"></span></div>
  <div class="row"><span>ğŸŒ§ Rain</span><span id="rain"></span></div>
  <div class="row"><span>ğŸ’¨ Wind Speed</span><span id="windSpeed"></span></div>
  <div class="row"><span>ğŸ§­ Wind Direction</span><span id="windDir"></span></div>
  <div class="row"><span>ğŸ‘ Visibility</span><span id="visibility"></span></div>
  <div class="row"><span>ğŸ“‰ Min Temp</span><span id="minTemp"></span></div>
  <div class="row"><span>ğŸ“ˆ Max Temp</span><span id="maxTemp"></span></div>
  <div class="row"><span>ğŸ“Š Avg Temp</span><span id="avgTemp"></span></div>
  <div class="row"><span>ğŸ•’ Last Update</span><span id="time"></span></div>

  <canvas id="tempChart" height="120"></canvas>

  <div class="footer">
    Intelligent IoT Weather Monitoring & Analytics System
  </div>
</div>

<script>
let chart;

async function fetchData() {
  const res = await fetch("/api/latest");
  const data = await res.json();
  if (data.message) return;

  document.getElementById("temp").innerText = data.temperature + " Â°C";
  document.getElementById("trend").innerText = data.trend;
  document.getElementById("hum").innerText = data.humidity + " %";
  document.getElementById("rain").innerText = data.rain;
  document.getElementById("windSpeed").innerText = data.wind_speed + " km/h";
  document.getElementById("windDir").innerText = data.wind_direction;
  document.getElementById("visibility").innerText = data.visibility + " %";
  document.getElementById("minTemp").innerText = data.min_temp + " Â°C";
  document.getElementById("maxTemp").innerText = data.max_temp + " Â°C";
  document.getElementById("avgTemp").innerText = data.avg_temp + " Â°C";
  document.getElementById("time").innerText = data.time;

  const statusBox = document.getElementById("deviceStatus");
  if (data.device_status === "Offline") {
    statusBox.innerText = "ğŸ”´ Device Offline";
    statusBox.style.background = "#ff4d4d";
  } else {
    statusBox.innerText = "ğŸŸ¢ Device Online";
    statusBox.style.background = "#28a745";
  }

  const alertBox = document.getElementById("alertBox");
  if (data.alert && data.alert !== "Normal") {
    alertBox.style.display = "block";
    alertBox.innerText = "âš  " + data.alert;
    alertBox.style.background = "#ff9900";
  } else {
    alertBox.style.display = "none";
  }

  loadChart();
}

async function loadChart() {
  const res = await fetch("/api/history");
  const data = await res.json();

  const temps = data.map(item => item.temperature).reverse();
  const times = data.map(item => item.time).reverse();

  const ctx = document.getElementById("tempChart").getContext("2d");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: times,
      datasets: [{
        label: "Temperature Trend",
        data: temps,
        borderColor: "#ff4d4d",
        backgroundColor: "rgba(255,77,77,0.2)",
        tension: 0.3
      }]
    },
    options: { responsive: true }
  });
}

setInterval(fetchData, 5000);
fetchData();
</script>

</body>
</html>
